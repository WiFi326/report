<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الإعدادات - نظام التقارير</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        .employee-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .employee-item {
            transition: all 0.2s ease;
        }
        
        .employee-item:hover {
            background-color: #f1f5f9;
        }
        
        .delete-btn {
            transition: all 0.2s ease;
        }
        
        .delete-btn:hover {
            color: #ef4444;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- حاوية الإشعارات -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50"></div>
    
    <!-- محتوى الإعدادات -->
    <div class="p-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">الإعدادات</h1>
            
            <div class="space-y-6">
                <!-- الوضع الليلي/النهاري -->
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">الوضع الليلي</h3>
                        <p class="text-gray-600">تبديل بين الوضع الليلي والنهاري</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <!-- إعدادات الموظف -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">معلومات الموظف</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">اسم الموظف</label>
                            <input type="text" id="employeeNameSetting" class="w-full p-2 border rounded-lg" value="امير مهند ">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">القسم</label>
                            <select id="departmentSetting" class="w-full p-2 border rounded-lg">
                                <option>متابع صباحي</option>
                                <option>متابع مسائي</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- قسم إدارة موظفي الصيانة -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">إدارة موظفي الصيانة</h3>
                    
                    <!-- نموذج إضافة موظف جديد -->
                    <div class="mb-6 p-4 bg-white rounded-lg border border-gray-200">
                        <h4 class="text-md font-semibold text-gray-700 mb-3">إضافة موظف صيانة جديد</h4>
                        <div class="flex gap-2">
                            <input type="text" id="newMaintenanceEmployee" placeholder="اسم الموظف الجديد" class="flex-1 p-2 border rounded-lg">
                            <button onclick="addMaintenanceEmployee()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                <i class="fas fa-plus ml-1"></i>
                                إضافة
                            </button>
                        </div>
                    </div>

                    <!-- زر لعرض قائمة الموظفين -->
                    <div class="mt-4">
                        <button onclick="toggleEmployeesDialog()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center">
                            <i class="fas fa-users ml-2"></i>
                            عرض موظفي الصيانة
                        </button>
                    </div>
                </div>

                <!-- قسم حذف بيانات سجل التقارير -->
                <div class="p-4 bg-gray-50 rounded-lg border border-red-200">
                    <h3 class="text-lg font-semibold text-red-800 mb-4">حذف بيانات سجل التقارير</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">اختر الشهر للحذف</label>
                        <select id="deleteMonth" class="w-full p-2 border rounded-lg">
                            <option value="">اختر الشهر</option>
                            <option value="0">يناير</option>
                            <option value="1">فبراير</option>
                            <option value="2">مارس</option>
                            <option value="3">أبريل</option>
                            <option value="4">مايو</option>
                            <option value="5">يونيو</option>
                            <option value="6">يوليو</option>
                            <option value="7">أغسطس</option>
                            <option value="8">سبتمبر</option>
                            <option value="9">أكتوبر</option>
                            <option value="10">نوفمبر</option>
                            <option value="11">ديسمبر</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور</label>
                        <input type="password" id="deletePassword" class="w-full p-2 border rounded-lg" placeholder="أدخل كلمة المرور">
                    </div>
                    
                    <button onclick="confirmDeleteReports()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                        <i class="fas fa-trash ml-1"></i>
                        حذف التقارير
                    </button>
                </div>

                <!-- حفظ الإعدادات -->
                <div class="text-center">
                    <button onclick="saveSettings()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-save ml-1"></i>
                        حفظ الإعدادات
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مربع الحوار لقائمة الموظفين -->
    <div id="employeesDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-11/12 md:w-1/2 lg:w-1/3 max-h-96 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">قائمة موظفي الصيانة</h3>
                <button onclick="toggleEmployeesDialog()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <input type="text" id="employeeSearch" placeholder="ابحث عن موظف..." 
                       class="w-full p-2 border rounded-lg mb-3" oninput="filterEmployees()">
                <div id="maintenanceEmployeesList" class="employee-list max-h-56 overflow-y-auto">
                    <!-- سيتم ملء الموظفين هنا -->
                </div>
            </div>
            <div class="p-4 border-t flex justify-end">
                <button onclick="toggleEmployeesDialog()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <!--تأكيد حذف البيانات-->
    <div id="deleteConfirmDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-11/12 md:w-1/2 lg:w-1/3">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">تأكيد الحذف</h3>
                <button onclick="closeDeleteConfirmDialog()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <p id="deleteConfirmMessage" class="text-gray-700 mb-4">هل أنت متأكد من أنك تريد حذف جميع التقارير لشهر محدد؟ هذا الإجراء لا يمكن التراجع عنه.</p>
            </div>
            <div class="p-4 border-t flex justify-end space-x-2 space-x-reverse">
                <button onclick="closeDeleteConfirmDialog()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    إلغاء
                </button>
                <button onclick="deleteReportsByMonth()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                    تأكيد الحذف
                </button>
            </div>
        </div>
    </div>

    <script>
        // متغيرات خاصة بالإعدادات
        let maintenanceEmployees = [];
        
        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            document.getElementById('darkModeToggle').addEventListener('change', toggleDarkMode);
        });
        
        // تحميل الإعدادات
        function loadSettings() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const savedSettings = localStorage.getItem('settings');
                
                if (savedSettings) {
                    const settingsData = JSON.parse(savedSettings);
                    document.getElementById('employeeNameSetting').value = currentUser.name;
                    document.getElementById('departmentSetting').value = settingsData.department || 'الدعم الفني';
                    document.getElementById('darkModeToggle').checked = settingsData.darkMode || false;
                    
                    if (settingsData.darkMode) {
                        document.body.classList.add('dark', 'bg-gray-900');
                        document.body.classList.remove('bg-gray-50');
                    }
                } else {
                    document.getElementById('employeeNameSetting').value = currentUser.name;
                    document.getElementById('departmentSetting').value = 'الدعم الفني';
                    document.getElementById('darkModeToggle').checked = false;
                }
                
                loadMaintenanceEmployees();
                
            } catch (error) {
                console.error('خطأ في تحميل الإعدادات:', error);
                document.getElementById('employeeNameSetting').value = currentUser.name;
                document.getElementById('departmentSetting').value = 'الدعم الفني';
                document.getElementById('darkModeToggle').checked = false;
                loadMaintenanceEmployees();
            }
        }
        
        // تحميل موظفي الصيانة
        function loadMaintenanceEmployees() {
            try {
                const savedEmployees = localStorage.getItem('maintenanceEmployees');
                if (savedEmployees) {
                    maintenanceEmployees = JSON.parse(savedEmployees);
                    displayMaintenanceEmployees();
                }
            } catch (error) {
                console.error('خطأ في تحميل موظفي الصيانة:', error);
                maintenanceEmployees = [];
            }
        }
        
        // عرض موظفي الصيانة
        function displayMaintenanceEmployees() {
            const employeesList = document.getElementById('maintenanceEmployeesList');
            employeesList.innerHTML = '';
            
            if (maintenanceEmployees.length === 0) {
                employeesList.innerHTML = '<p class="text-center text-gray-500 py-4">لا يوجد موظفين مضافين</p>';
                return;
            }
            
            maintenanceEmployees.forEach((employee, index) => {
                const employeeItem = document.createElement('div');
                employeeItem.className = 'flex justify-between items-center p-3 border-b border-gray-200 employee-item';
                employeeItem.innerHTML = `
                    <span class="text-gray-700">${employee}</span>
                    <button onclick="deleteMaintenanceEmployee(${index})" class="delete-btn text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                employeesList.appendChild(employeeItem);
            });
        }
        
        // تبديل الوضع الليلي
        function toggleDarkMode() {
            const isDark = document.getElementById('darkModeToggle').checked;
            
            if (isDark) {
                document.body.classList.add('dark', 'bg-gray-900');
                document.body.classList.remove('bg-gray-50');
            } else {
                document.body.classList.remove('dark', 'bg-gray-900');
                document.body.classList.add('bg-gray-50');
            }
        }
        
        // إضافة موظف صيانة جديد
        function addMaintenanceEmployee() {
            const newEmployeeInput = document.getElementById('newMaintenanceEmployee');
            const newEmployeeName = newEmployeeInput.value.trim();
            
            if (!newEmployeeName) {
                showNotification('يرجى إدخال اسم الموظف', 'warning');
                return;
            }
            
            if (maintenanceEmployees.includes(newEmployeeName)) {
                showNotification('هذا الموظف مضاف مسبقاً', 'warning');
                return;
            }
            
            maintenanceEmployees.push(newEmployeeName);
            localStorage.setItem('maintenanceEmployees', JSON.stringify(maintenanceEmployees));
            
            displayMaintenanceEmployees();
            newEmployeeInput.value = '';
            
            showNotification('تم إضافة الموظف بنجاح', 'success');
        }
        
        // حذف موظف صيانة
        function deleteMaintenanceEmployee(index) {
            if (confirm(`هل أنت متأكد من حذف الموظف "${maintenanceEmployees[index]}"؟`)) {
                maintenanceEmployees.splice(index, 1);
                localStorage.setItem('maintenanceEmployees', JSON.stringify(maintenanceEmployees));
                
                displayMaintenanceEmployees();
                showNotification('تم حذف الموظف بنجاح', 'warning');
            }
        }
        
        // عرض/إخفاء مربع حوار الموظفين
        function toggleEmployeesDialog() {
            const dialog = document.getElementById('employeesDialog');
            dialog.classList.toggle('hidden');
            
            // إذا كان المربع يظهر، قم بتحميل الموظفين
            if (!dialog.classList.contains('hidden')) {
                loadMaintenanceEmployees();
                document.getElementById('employeeSearch').value = '';
            }
        }
        
        // تصفية الموظفين حسب البحث
        function filterEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const employeeItems = document.querySelectorAll('#maintenanceEmployeesList .employee-item');
            
            employeeItems.forEach(item => {
                const employeeName = item.querySelector('span').textContent.toLowerCase();
                if (employeeName.includes(searchTerm)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }
        
        // حفظ الإعدادات
        function saveSettings() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                showNotification('يجب تسجيل الدخول أولاً', 'error');
                window.location.href = 'login.html';
                return;
            }
            
            const employeeName = document.getElementById('employeeNameSetting').value;
            const department = document.getElementById('departmentSetting').value;
            const darkMode = document.getElementById('darkModeToggle').checked;
            
            if (!employeeName.trim()) {
                showNotification('يرجى إدخال اسم الموظف', 'warning');
                return;
            }
            
            showNotification('جاري حفظ الإعدادات...', 'info', 1500);
            
            const settingsData = {
                employeeName: employeeName,
                department: department,
                darkMode: darkMode,
                updatedAt: new Date().toISOString()
            };
            
            try {
                // حفظ في التخزين المحلي
                localStorage.setItem('settings', JSON.stringify(settingsData));
                showNotification('تم حفظ الإعدادات بنجاح!', 'success');
                
                // تحديث اسم المستخدم في الجلسة إذا تم تغييره
                currentUser.name = employeeName;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                
            } catch (error) {
                console.error('خطأ في حفظ الإعدادات:', error);
                showNotification('حدث خطأ في حفظ الإعدادات', 'error');
            }
        }
        
        // كلمة المرور الافتراضية (يمكن تغييرها)
        const DELETE_PASSWORD = "admin123";
        
        // فتح مربع حوار تأكيد الحذف
        function confirmDeleteReports() {
            const monthSelect = document.getElementById('deleteMonth');
            const passwordInput = document.getElementById('deletePassword');
            const selectedMonth = monthSelect.value;
            const password = passwordInput.value.trim();
            
            if (!selectedMonth) {
                showNotification('يرجى اختيار الشهر أولاً', 'warning');
                return;
            }
            
            if (!password) {
                showNotification('يرجى إدخال كلمة المرور', 'warning');
                return;
            }
            
            if (password !== DELETE_PASSWORD) {
                showNotification('كلمة المرور غير صحيحة', 'error');
                return;
            }
            
            // عرض مربع التأكيد
            const monthNames = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
                               "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            const message = `هل أنت متأكد من أنك تريد حذف جميع التقارير لشهر ${monthNames[selectedMonth]}؟ هذا الإجراء لا يمكن التراجع عنه.`;
            
            document.getElementById('deleteConfirmMessage').textContent = message;
            document.getElementById('deleteConfirmDialog').classList.remove('hidden');
        }
        
        // إغلاق مربع حوار التأكيد
        function closeDeleteConfirmDialog() {
            document.getElementById('deleteConfirmDialog').classList.add('hidden');
        }
        
        // حذف التقارير حسب الشهر
        function deleteReportsByMonth() {
            const monthSelect = document.getElementById('deleteMonth');
            const selectedMonth = parseInt(monthSelect.value);
            
            // الحصول على التقارير من التخزين المحلي
            const reports = JSON.parse(localStorage.getItem('reports') || '[]');
            
            // تصفية التقارير وإزالة تلك التي تنتمي للشهر المحدد
            const updatedReports = reports.filter(report => {
                const reportDate = new Date(report.date);
                return reportDate.getMonth() !== selectedMonth;
            });
            
            // حساب عدد التقارير المحذوفة
            const deletedCount = reports.length - updatedReports.length;
            
            if (deletedCount === 0) {
                showNotification('لا توجد تقارير للشهر المحدد', 'info');
                closeDeleteConfirmDialog();
                return;
            }
            
            // تحديث التخزين المحلي
            localStorage.setItem('reports', JSON.stringify(updatedReports));
            
            // إغلاق مربع الحوار وإعادة تعيين الحقول
            closeDeleteConfirmDialog();
            monthSelect.value = '';
            document.getElementById('deletePassword').value = '';
            
            // إظهار إشعار النجاح
            showNotification(`تم حذف ${deletedCount} تقرير بنجاح`, 'success');
        }
        
        // نظام الإشعارات
        function showNotification(message, type = 'success', duration = 4000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `bg-white p-4 rounded-lg shadow-lg border-l-4 ${type === 'success' ? 'border-green-500' : type === 'error' ? 'border-red-500' : type === 'warning' ? 'border-yellow-500' : 'border-blue-500'} mb-2`;
            
            const icons = {
                success: 'fas fa-check-circle text-green-500',
                error: 'fas fa-times-circle text-red-500',
                warning: 'fas fa-exclamation-triangle text-yellow-500',
                info: 'fas fa-info-circle text-blue-500'
            };

            notification.innerHTML = `
                <div class="flex items-start">
                    <i class="${icons[type]} mt-1 ml-2"></i>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            container.appendChild(notification);

            // إخفاء الإشعار تلقائياً
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }
    </script>
</body>
</html>